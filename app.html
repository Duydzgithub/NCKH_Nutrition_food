<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Ninja - AI Nutrition Analyzer</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2E7D32">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Food Ninja">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="assets/icons/icon-192x192.svg">
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/app-professional.css?v=1.1">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen hidden">
        <div class="loading-logo">
            <i class="fas fa-utensils"></i>
        </div>
        <div class="loading-text">Food Ninja</div>
        <div class="spinner-border text-light" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>

    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <button class="btn btn-outline-light btn-sm" onclick="goToIndex()">
                            <i class="fas fa-arrow-left me-2"></i>
                            Trang ch·ªß
                        </button>
                    </div>
                    <div class="col">
                        <h1 class="app-title mb-0">
                            <i class="fas fa-utensils app-logo"></i>
                            Food Ninja
                        </h1>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-outline-light btn-sm" onclick="showInstallBanner()" title="Demo Install Banner">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- PWA Install Banner -->
        <div id="installBanner" class="install-banner">
            <div class="container">
                <div class="install-content">
                    <div class="install-icon">
                        <i class="fas fa-mobile-alt"></i>
                    </div>
                    <div class="install-text">
                        <h5 class="install-title">C√†i ƒë·∫∑t Food Ninja</h5>
                        <p class="install-subtitle">T·∫£i app ƒë·ªÉ s·ª≠ d·ª•ng offline v√† tr·∫£i nghi·ªám t·ªët h∆°n</p>
                    </div>
                    <div class="install-actions">
                        <button class="btn btn-light btn-sm" onclick="installPWA()" id="installBtn">
                            <i class="fas fa-download me-1"></i>
                            C√†i ƒë·∫∑t
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="showInstallInstructions()">
                            <i class="fas fa-info-circle me-1"></i>
                            H∆∞·ªõng d·∫´n
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="dismissInstallBanner()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Camera Section -->
            <section class="camera-section">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-camera text-primary"></i>
                        Ch·ª•p ho·∫∑c ch·ªçn ·∫£nh th·ª±c ph·∫©m
                    </h2>
                </div>
                <div class="card-body">
                    <!-- Single Image Display Container -->
                    <div class="image-display-container">
                        <!-- Camera View (when active) -->
                        <div id="cameraView" class="camera-view hidden">
                            <video id="cameraVideo" class="camera-video" autoplay playsinline></video>
                            <canvas id="cameraCanvas" class="hidden"></canvas>
                            <div class="camera-crosshair">
                                <div class="crosshair-inner"></div>
                            </div>
                        </div>
                        
                        <!-- Default State (no camera, with image preview capability) -->
                        <div id="defaultView" class="default-view">
                            <!-- Upload area (shown when no image) -->
                            <div id="uploadArea" class="upload-area">
                                <i class="fas fa-camera upload-icon"></i>
                                <h4 class="upload-title">Ch·ª•p ho·∫∑c ch·ªçn ·∫£nh th·ª±c ph·∫©m</h4>
                                <p class="upload-subtitle">Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                            </div>
                            
                            <!-- Image preview (shown when image selected) -->
                            <img id="previewImg" src="" alt="Preview" class="preview-img hidden">
                        </div>
                    </div>
                    
                    <!-- Camera Controls -->
                    <div class="camera-controls">
                        <button class="btn btn-primary btn-lg" onclick="openCamera()" id="cameraBtn">
                            <i class="fas fa-camera me-2"></i>
                            Ch·ª•p ·∫£nh
                        </button>
                        <button class="btn btn-outline-primary btn-lg" onclick="openGallery()">
                            <i class="fas fa-images me-2"></i>
                            Ch·ªçn t·ª´ th∆∞ vi·ªán
                        </button>
                        <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFileSelect(event)">
                        <button class="btn btn-success btn-lg hidden" onclick="analyzeImage()" id="analyzeBtn">
                            <i class="fas fa-search me-2"></i>
                            Ph√¢n t√≠ch th·ª±c ph·∫©m
                        </button>
                        <button class="btn btn-secondary hidden" onclick="removeImage()" id="removeBtn">
                            <i class="fas fa-trash me-2"></i>
                            X√≥a ·∫£nh
                        </button>
                        <button class="btn btn-outline-secondary hidden" onclick="closeCamera()" id="closeCameraBtn">
                            <i class="fas fa-times me-2"></i>
                            ƒê√≥ng camera
                        </button>
                        <button class="btn btn-primary hidden" onclick="capturePhoto()" id="captureBtn">
                            <i class="fas fa-camera me-2"></i>
                            Ch·ª•p
                        </button>
                    </div>
                </div>
            </section>

            <!-- Analysis Results Section -->
            <section id="analysisResults" class="analysis-results hidden">
                <div class="card-header">
                    <div class="result-header">
                        <h3 class="result-title">
                            <i class="fas fa-check-circle text-success"></i>
                            K·∫øt qu·∫£ ph√¢n t√≠ch
                        </h3>
                        <div id="confidenceBadge" class="confidence-badge">
                            <i class="fas fa-chart-line me-1"></i>
                            <span id="confidenceText">0%</span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="resultsContent">
                        <!-- Results will be populated here -->
                    </div>
                </div>
            </section>

            <!-- Chat Section -->
            <section class="chat-section">
                <div class="chat-header">
                    <i class="fas fa-robot me-2"></i>
                    H·ªèi AI v·ªÅ dinh d∆∞·ª°ng
                </div>
                <div class="chat-container">
                    <div id="chatMessages" class="chat-messages">
                        <div class="chat-message message-assistant">
                            <div class="message-bubble">
                                Xin ch√†o! T√¥i c√≥ th·ªÉ gi√∫p b·∫°n t√¨m hi·ªÉu v·ªÅ dinh d∆∞·ª°ng c·ªßa th·ª±c ph·∫©m. H√£y ch·ª•p ·∫£nh ho·∫∑c h·ªèi t√¥i b·∫•t k·ª≥ c√¢u h·ªèi n√†o! üçé
                            </div>
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" class="chat-input" placeholder="H·ªèi v·ªÅ dinh d∆∞·ª°ng..." onkeypress="if(event.key==='Enter')sendChatMessage()">
                        <button class="chat-send-btn" onclick="sendChatMessage()" id="sendBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(reg => console.log('‚úÖ Service Worker registered'))
                .catch(err => console.log('‚ùå Service Worker registration failed'));
        }
    </script>

    <!-- App JavaScript -->
    <script>
        // App State
        const appState = {
            selectedImage: null,
            isAnalyzing: false,
            currentStream: null,
            facingMode: 'environment' // 'user' for front camera, 'environment' for back camera
        };

        // API Configuration
        const API_BASE_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') ? 'http://localhost:5000' : window.location.origin

        // DOM Elements
        const elements = {
            cameraVideo: null,
            cameraCanvas: null,
            previewImg: null,
            uploadArea: null,
            cameraView: null,
            defaultView: null,
            analyzeBtn: null,
            removeBtn: null,
            closeCameraBtn: null,
            captureBtn: null,
            cameraBtn: null,
            chatInput: null,
            chatMessages: null,
            loadingScreen: null
        };

        // Initialize DOM elements when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Food Ninja App starting...');
            
            // Get DOM elements
            elements.cameraVideo = document.getElementById('cameraVideo');
            elements.cameraCanvas = document.getElementById('cameraCanvas');
            elements.previewImg = document.getElementById('previewImg');
            elements.uploadArea = document.getElementById('uploadArea');
            elements.cameraView = document.getElementById('cameraView');
            elements.defaultView = document.getElementById('defaultView');
            elements.analyzeBtn = document.getElementById('analyzeBtn');
            elements.removeBtn = document.getElementById('removeBtn');
            elements.closeCameraBtn = document.getElementById('closeCameraBtn');
            elements.captureBtn = document.getElementById('captureBtn');
            elements.cameraBtn = document.getElementById('cameraBtn');
            elements.chatInput = document.getElementById('chatInput');
            elements.chatMessages = document.getElementById('chatMessages');
            elements.loadingScreen = document.getElementById('loadingScreen');

            console.log('‚úÖ App initialized successfully');

            // Warm up backend to avoid cold start delays
            warmBackend();
        });

        // Warm-up function to wake server (Render cold start)
        async function warmBackend() {
            const healthUrl = `${API_BASE_URL}/health`;
            try {
                const controller = new AbortController();
                const t = setTimeout(() => controller.abort(), 4000);
                const res = await fetch(healthUrl, { method: 'GET', signal: controller.signal, cache: 'no-store' });
                clearTimeout(t);
                console.log('üü¢ Backend warm-up status:', res.status);
            } catch (e) {
                console.warn('üü† Backend warm-up failed (will retry silently):', e?.message || e);
                // Retry once after a short delay
                setTimeout(async () => {
                    try {
                        const r = await fetch(healthUrl, { method: 'GET', cache: 'no-store' });
                        console.log('üü¢ Backend warm-up retry status:', r.status);
                    } catch {}
                }, 3000);
            }
        };

        // Re-warm when tab becomes visible again after being idle
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                warmBackend();
            }
        });

        // Camera Functions
        async function openCamera() {
            try {
                console.log('üìπ Opening camera...');
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: appState.facingMode }
                });
                
                appState.currentStream = stream;
                elements.cameraVideo.srcObject = stream;
                
                // Show camera view and hide others
                elements.defaultView.classList.add('hidden');
                elements.cameraView.classList.remove('hidden');
                elements.cameraVideo.classList.remove('hidden');
                
                // Show camera controls
                showCameraControls();
                
                console.log('‚úÖ Camera opened successfully');
            } catch (error) {
                console.error('‚ùå Camera error:', error);
                alert('Kh√¥ng th·ªÉ m·ªü camera. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p camera.');
            }
        }

        function closeCamera() {
            if (appState.currentStream) {
                appState.currentStream.getTracks().forEach(track => track.stop());
                appState.currentStream = null;
            }
            
            // Hide camera view and show default view
            elements.cameraView.classList.add('hidden');
            elements.cameraVideo.classList.add('hidden');
            elements.defaultView.classList.remove('hidden');
            hideCameraControls();
            
            console.log('üìπ Camera closed');
        }

        function showCameraControls() {
            elements.cameraBtn.classList.add('hidden');
            elements.closeCameraBtn.classList.remove('hidden');
            elements.captureBtn.classList.remove('hidden');
            
            // Hide gallery button when camera is active
            const galleryBtn = document.querySelector('.btn[onclick="openGallery()"]');
            if (galleryBtn) galleryBtn.classList.add('hidden');
        }

        function hideCameraControls() {
            elements.cameraBtn.classList.remove('hidden');
            elements.closeCameraBtn.classList.add('hidden');
            elements.captureBtn.classList.add('hidden');
            
            // Show gallery button when camera is closed
            const galleryBtn = document.querySelector('.btn[onclick="openGallery()"]');
            if (galleryBtn) galleryBtn.classList.remove('hidden');
        }

        function capturePhoto() {
            if (!elements.cameraVideo || !elements.cameraCanvas) return;
            
            const canvas = elements.cameraCanvas;
            const video = elements.cameraVideo;
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0);
            
            // Convert to blob
            canvas.toBlob(function(blob) {
                if (blob) {
                    appState.selectedImage = new File([blob], 'camera-photo.jpg', { type: 'image/jpeg' });
                    
                    // Show preview
                    const url = URL.createObjectURL(blob);
                    elements.previewImg.src = url;
                    showImagePreview();
                    
                    closeCamera();
                    console.log('üì∏ Photo captured');
                }
            }, 'image/jpeg', 0.8);
        }

        function openGallery() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.click();
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                appState.selectedImage = file;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    elements.previewImg.src = e.target.result;
                    showImagePreview();
                };
                reader.readAsDataURL(file);
                
                console.log('üìÅ File selected:', file.name);
            }
        }

        function showImagePreview() {
            // Hide camera view and show default view with image
            elements.cameraView.classList.add('hidden');
            elements.defaultView.classList.remove('hidden');
            
            // Hide upload area and show image preview
            elements.uploadArea.classList.add('hidden');
            elements.previewImg.classList.remove('hidden');
            
            // Hide camera controls and show analysis controls
            elements.cameraBtn.classList.add('hidden');
            elements.analyzeBtn.classList.remove('hidden');
            elements.removeBtn.classList.remove('hidden');
            
            // Add animation class to image
            elements.previewImg.style.animation = 'imageSlideIn 0.6s ease-out';
            
            console.log('üñºÔ∏è Image preview shown');
        }

        function removeImage() {
            appState.selectedImage = null;
            elements.previewImg.src = '';
            
            // Hide image preview and show upload area
            elements.previewImg.classList.add('hidden');
            elements.uploadArea.classList.remove('hidden');
            
            // Show camera controls and hide analysis controls
            elements.cameraBtn.classList.remove('hidden');
            elements.analyzeBtn.classList.add('hidden');
            elements.removeBtn.classList.add('hidden');
            
            // Hide results
            document.getElementById('analysisResults').classList.add('hidden');
            
            console.log('üóëÔ∏è Image removed');
        }

        // Analysis Functions
        async function analyzeImage() {
            if (!appState.selectedImage) {
                alert('Vui l√≤ng ch·ªçn ·∫£nh tr∆∞·ªõc khi ph√¢n t√≠ch.');
                return;
            }
            
            if (appState.isAnalyzing) {
                alert('ƒêang ph√¢n t√≠ch, vui l√≤ng ch·ªù...');
                return;
            }
            
            console.log('üîç Starting image analysis...');
            appState.isAnalyzing = true;
            
            // Show loading state
            elements.analyzeBtn.classList.add('loading');
            elements.analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang ph√¢n t√≠ch...';
            elements.analyzeBtn.disabled = true;
            
            try {
                const formData = new FormData();
                formData.append('image', appState.selectedImage);
                
                console.log('üì§ Sending request to:', `${API_BASE_URL}/predict`);
                console.log('üìé File size:', appState.selectedImage.size, 'bytes');
                console.log('üìé File type:', appState.selectedImage.type);
                
                const response = await fetch(`${API_BASE_URL}/predict`, {
                    method: 'POST',
                    body: formData
                });
                
                console.log('üì• Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.error || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('üìä Analysis result:', result);
                
                if (result.error) {
                    throw new Error(result.error);
                } else {
                    displayAnalysisResults(result);
                }
                
            } catch (error) {
                console.error('‚ùå Analysis error:', error);
                alert('L·ªói ph√¢n t√≠ch: ' + error.message);
            } finally {
                appState.isAnalyzing = false;
                elements.analyzeBtn.classList.remove('loading');
                elements.analyzeBtn.innerHTML = '<i class="fas fa-search me-2"></i>Ph√¢n t√≠ch th·ª±c ph·∫©m';
                elements.analyzeBtn.disabled = false;
            }
        }

        function displayAnalysisResults(data) {
            console.log('üìã Displaying results:', data);
            
            const resultsSection = document.getElementById('analysisResults');
            const resultsContent = document.getElementById('resultsContent');
            const confidenceBadge = document.getElementById('confidenceBadge');
            const confidenceText = document.getElementById('confidenceText');
            
            if (!resultsSection || !resultsContent) {
                console.error('‚ùå Results sections not found');
                return;
            }
            
            // Update confidence badge
            const confidence = (data.probability || 0) * 100;
            confidenceText.textContent = confidence.toFixed(1) + '%';
            
            if (confidence >= 80) {
                confidenceBadge.className = 'confidence-badge';
            } else if (confidence >= 60) {
                confidenceBadge.className = 'confidence-badge low';
            } else {
                confidenceBadge.className = 'confidence-badge very-low';
            }
            
            // Build nutrition display
            let nutritionHtml = '';
            if (data.nutrition && data.nutrition.items && data.nutrition.items.length > 0) {
                const item = data.nutrition.items[0];
                nutritionHtml = `
                    <div class="nutrition-section">
                        <h4 class="mb-3">Th√¥ng tin dinh d∆∞·ª°ng</h4>
                        <div class="nutrition-grid">
                            <div class="nutrition-item">
                                <div class="nutrition-value">${item.calories || 0}</div>
                                <div class="nutrition-label">Calories</div>
                            </div>
                            <div class="nutrition-item">
                                <div class="nutrition-value">${item.protein_g || 0}<span class="nutrition-unit">g</span></div>
                                <div class="nutrition-label">Protein</div>
                            </div>
                            <div class="nutrition-item">
                                <div class="nutrition-value">${item.carbohydrates_total_g || 0}<span class="nutrition-unit">g</span></div>
                                <div class="nutrition-label">Carbs</div>
                            </div>
                            <div class="nutrition-item">
                                <div class="nutrition-value">${item.fat_total_g || 0}<span class="nutrition-unit">g</span></div>
                                <div class="nutrition-label">Fat</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                nutritionHtml = '<div class="text-muted">Kh√¥ng c√≥ th√¥ng tin dinh d∆∞·ª°ng</div>';
            }
            
            // Display food name and details
            resultsContent.innerHTML = `
                <div class="row">
                    <div class="col-12">
                        <h4 class="mb-3">
                            Th·ª±c ph·∫©m: <span class="food-name">${data.food_name || 'Kh√¥ng x√°c ƒë·ªãnh'}</span>
                        </h4>
                        ${data.low_confidence ? '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>ƒê·ªô tin c·∫≠y th·∫•p - k·∫øt qu·∫£ c√≥ th·ªÉ kh√¥ng ch√≠nh x√°c</div>' : ''}
                    </div>
                </div>
                ${nutritionHtml}
                ${data.ai_answer ? `
                    <div class="ai-advice">
                        <h5 class="ai-advice-title">
                            <i class="fas fa-robot me-2"></i>
                            L·ªùi khuy√™n t·ª´ AI
                        </h5>
                        <p class="ai-advice-content">${data.ai_answer}</p>
                    </div>
                ` : ''}
                ${data.alternatives && data.alternatives.length > 0 ? `
                    <div class="mt-3">
                        <h6>C√°c l·ª±a ch·ªçn kh√°c:</h6>
                        <div class="d-flex flex-wrap gap-2">
                            ${data.alternatives.map(alt => `<span class="badge bg-secondary">${alt}</span>`).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
            
            // Show results section with animation
            resultsSection.classList.remove('hidden');
            resultsSection.classList.add('fade-in');
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Chat Functions
        async function sendChatMessage() {
            const input = elements.chatInput;
            const message = input.value.trim();
            
            if (!message) return;
            
            console.log('üí¨ Sending chat message:', message);
            input.value = '';
            
            // Add user message
            addChatMessage(message, 'user');
            
            // Add loading message
            const loadingId = 'loading-' + Date.now();
            addChatMessage('ƒêang tr·∫£ l·ªùi...', 'assistant', loadingId);
            
            try {
                // Simple retry for backend cold start: up to 2 attempts
                const attemptFetch = async (attempt = 1) => {
                    const response = await fetch(`${API_BASE_URL}/chat`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            context: appState.selectedImage ? 'Ng∆∞·ªùi d√πng ƒë√£ ch·ª•p/ch·ªçn ·∫£nh th·ª±c ph·∫©m.' : null
                        })
                    });
                    console.log('üì• Chat response status:', response.status);
                    
                    // If backend is waking up (502/503/504), wait and retry once
                    if ((response.status === 502 || response.status === 503 || response.status === 504) && attempt < 2) {
                        addChatMessage('‚è≥ Server ƒëang kh·ªüi ƒë·ªông, vui l√≤ng ƒë·ª£i v√†i gi√¢y...', 'assistant');
                        await new Promise(r => setTimeout(r, 3500));
                        return attemptFetch(attempt + 1);
                    }
                    
                    // Ensure JSON before parsing
                    const ct = response.headers.get('content-type') || '';
                    if (!response.ok) {
                        let errMsg = `HTTP ${response.status}`;
                        if (ct.includes('application/json')) {
                            try { const e = await response.json(); errMsg = e.error || errMsg; } catch {}
                        } else {
                            // Read as text (likely HTML error page)
                            try { await response.text(); } catch {}
                        }
                        throw new Error(errMsg);
                    }
                    
                    if (!ct.includes('application/json')) {
                        // Not JSON (e.g., an HTML error page). Show friendly error
                        throw new Error('Ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá t·ª´ server (kh√¥ng ph·∫£i JSON).');
                    }
                    
                    return response.json();
                };
                
                const result = await attemptFetch();
                console.log('üí¨ Chat result:', result);
                
                // Remove loading message
                document.getElementById(loadingId)?.remove();
                
                if (result && result.error) {
                    addChatMessage('L·ªói: ' + result.error, 'assistant');
                } else if (result && result.response) {
                    addChatMessage(result.response, 'assistant');
                } else {
                    addChatMessage('Xin l·ªói, t√¥i kh√¥ng th·ªÉ tr·∫£ l·ªùi ngay b√¢y gi·ªù. Vui l√≤ng th·ª≠ l·∫°i sau.', 'assistant');
                }
                
            } catch (error) {
                console.error('‚ùå Chat error:', error);
                document.getElementById(loadingId)?.remove();
                addChatMessage('L·ªói k·∫øt n·ªëi ho·∫∑c server ƒëang kh·ªüi ƒë·ªông. Vui l√≤ng th·ª≠ l·∫°i sau.', 'assistant');
            }
        }

        function addChatMessage(message, sender, messageId = null) {
            const chatMessages = elements.chatMessages;
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message message-${sender}`;
            if (messageId) messageDiv.id = messageId;
            
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    ${message}
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Utility Functions
        function showLoading(text = 'Loading...') {
            elements.loadingScreen.querySelector('.loading-text').textContent = text;
            elements.loadingScreen.classList.remove('hidden');
        }

        function hideLoading() {
            elements.loadingScreen.classList.add('hidden');
        }
        
        // Navigation Functions
        function goToIndex() {
            window.location.href = 'index.html';
        }

        // PWA Installation
        let deferredPrompt;
        const installBanner = document.getElementById('installBanner');

        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('üíæ PWA install prompt available');
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install banner after 3 seconds
            setTimeout(() => {
                if (!localStorage.getItem('installBannerDismissed')) {
                    showInstallBanner();
                }
            }, 3000);
        });

        function showInstallBanner() {
            if (installBanner) {
                installBanner.classList.remove('hidden');
            }
        }

        function dismissInstallBanner() {
            if (installBanner) {
                installBanner.classList.add('hidden');
                localStorage.setItem('installBannerDismissed', 'true');
            }
        }

        async function installPWA() {
            if (deferredPrompt) {
                try {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    
                    if (outcome === 'accepted') {
                        console.log('‚úÖ PWA installed successfully');
                        dismissInstallBanner();
                    } else {
                        console.log('‚ùå PWA installation declined');
                    }
                    
                    deferredPrompt = null;
                } catch (error) {
                    console.error('‚ùå PWA install error:', error);
                    showInstallInstructions();
                }
            } else {
                // Fallback for browsers that don't support PWA install
                showInstallInstructions();
            }
        }

        function showInstallInstructions() {
            const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isChrome = /Chrome/i.test(navigator.userAgent);
            const isSafari = /Safari/i.test(navigator.userAgent) && !/Chrome/i.test(navigator.userAgent);
            
            let instructions = '';
            
            if (isMobile) {
                if (isChrome) {
                    instructions = 'Tr√™n Android Chrome:\n1. Nh·∫•n menu (3 ch·∫•m)\n2. Ch·ªçn "Th√™m v√†o m√†n h√¨nh ch√≠nh"\n3. Nh·∫•n "Th√™m"';
                } else if (isSafari) {
                    instructions = 'Tr√™n iPhone Safari:\n1. Nh·∫•n n√∫t chia s·∫ª (m≈©i t√™n l√™n)\n2. Ch·ªçn "Th√™m v√†o m√†n h√¨nh ch√≠nh"\n3. Nh·∫•n "Th√™m"';
                } else {
                    instructions = 'ƒê·ªÉ c√†i ƒë·∫∑t app:\n1. M·ªü trang web b·∫±ng Chrome ho·∫∑c Safari\n2. T√¨m t√πy ch·ªçn "Th√™m v√†o m√†n h√¨nh ch√≠nh"\n3. L√†m theo h∆∞·ªõng d·∫´n';
                }
            } else {
                if (isChrome) {
                    instructions = 'Tr√™n Chrome desktop:\n1. Nh·∫•n icon c√†i ƒë·∫∑t ·ªü thanh ƒë·ªãa ch·ªâ\n2. Ho·∫∑c v√†o menu ‚Üí "C√†i ƒë·∫∑t Food Ninja"\n3. Nh·∫•n "C√†i ƒë·∫∑t"';
                } else {
                    instructions = 'ƒê·ªÉ c√†i ƒë·∫∑t app:\n1. M·ªü trang web b·∫±ng Chrome\n2. T√¨m icon c√†i ƒë·∫∑t ·ªü thanh ƒë·ªãa ch·ªâ\n3. L√†m theo h∆∞·ªõng d·∫´n';
                }
            }
            
            alert(instructions);
        }

        // Check if already installed
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ PWA was installed');
            dismissInstallBanner();
        });

        // Error Handling
        window.addEventListener('error', function(e) {
            console.error('‚ùå Global error:', e.error);
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('‚ùå Unhandled promise rejection:', e.reason);
        });

        console.log('‚úÖ Food Ninja JavaScript loaded');
    </script>
</body>
</html>
